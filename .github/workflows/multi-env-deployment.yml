name: Full Repository Deployment (Password Based)

on:
  push:
    branches:
      - development
      - qatest
      - uat

  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        type: choice
        default: "prod"
        options:
          - prod
      branch:
        description: "Select branch to deploy to production"
        required: true
        type: choice
        options:
          - development
          - qatest
          - uat
          - main
          - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Determine environment automatically OR manually
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment != '' && github.event.inputs.environment || (
                        github.ref_name == 'development' && 'dev' || 
                        github.ref_name == 'qatest' && 'qa' || 
                        github.ref_name == 'uat' && 'uat'
                      ) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Select Server & Path
        id: vars
        run: |
          if [[ "${ENVIRONMENT}" == "dev" ]]; then
            echo "server=${{ secrets.DEV_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.DEV_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${ENVIRONMENT}" == "qa" ]]; then
            echo "server=${{ secrets.QA_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.QA_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${ENVIRONMENT}" == "uat" ]]; then
            echo "server=${{ secrets.UAT_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.UAT_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${ENVIRONMENT}" == "prod" ]]; then
            echo "server=${{ secrets.PROD_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.PROD_PATH }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Deployment Directory
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "mkdir -p '${{ steps.vars.outputs.deploy_path }}'"

      - name: Backup Existing Deployment (NON-DEV)
        if: env.ENVIRONMENT != 'dev'
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "
          if [ -d \"${{ steps.vars.outputs.deploy_path }}\" ]; then
            rm -rf \"${{ steps.vars.outputs.deploy_path }}.backup_\"* || true
            mv \"${{ steps.vars.outputs.deploy_path }}\" \"${{ steps.vars.outputs.deploy_path }}.backup_\$(date +%F_%T)\"
          fi
          "

      - name: Upload Repository to Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "rm -rf \"${{ steps.vars.outputs.deploy_path }}\"/* || true"

          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          scp -o StrictHostKeyChecking=no -r ./ \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }}:${{ steps.vars.outputs.deploy_path }}

      - name: Rollback on Failure (NON-DEV)
        if: failure() && env.ENVIRONMENT != 'dev'
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "sh -c '
            latest_backup=\$(ls -td \"${{ steps.vars.outputs.deploy_path }}.backup_\"* 2>/dev/null | head -n 1)

            if [ ! -z \"\$latest_backup\" ]; then
              rm -rf \"${{ steps.vars.outputs.deploy_path }}\" || true
              mv \"\$latest_backup\" \"${{ steps.vars.outputs.deploy_path }}\"
            fi
          '"
