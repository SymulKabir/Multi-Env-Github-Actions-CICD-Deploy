name: Full Repository Deployment (Password Based)

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to deploy (dev, qa, uat, prod)"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment: ${{ github.event.inputs.env }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Define Server & Path
        id: vars
        run: |
          if [[ "${{ github.event.inputs.env }}" == "dev" ]]; then
            echo "server=${{ secrets.DEV_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.DEV_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.env }}" == "qa" ]]; then
            echo "server=${{ secrets.QA_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.QA_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.env }}" == "uat" ]]; then
            echo "server=${{ secrets.UAT_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.UAT_PATH }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.env }}" == "prod" ]]; then
            echo "server=${{ secrets.PROD_SERVER }}" >> $GITHUB_OUTPUT
            echo "deploy_path=${{ secrets.PROD_PATH }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Deploy Directory on Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "mkdir -p '${{ steps.vars.outputs.deploy_path }}'"

      - name: Backup Existing Deployment (QA/UAT/PROD)
        if: github.event.inputs.env != 'dev'
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "if [ -d '${{ steps.vars.outputs.deploy_path }}' ]; then \
             mv '${{ steps.vars.outputs.deploy_path }}' '${{ steps.vars.outputs.deploy_path }}.backup_$(date +%F_%T)'; \
           fi"

      - name: Upload Entire Repository to Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "rm -rf '${{ steps.vars.outputs.deploy_path }}/*'"

          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          scp -o StrictHostKeyChecking=no -r ./ ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }}:${{ steps.vars.outputs.deploy_path }}


      - name: Rollback on Failure
        if: failure()
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "if ls '${{ steps.vars.outputs.deploy_path }}.backup_*' 1> /dev/null 2>&1; then \
             latest_backup=$(ls -t '${{ steps.vars.outputs.deploy_path }}.backup_*' | head -n 1); \
             rm -rf '${{ steps.vars.outputs.deploy_path }}'; \
             mv \"$latest_backup\" '${{ steps.vars.outputs.deploy_path }}'; \
           fi"
