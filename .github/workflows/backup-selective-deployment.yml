name: Backup Selective Deployment (File / Folder)

on:
  push:
    branches:
      - development
      - qatest
      - uat

  workflow_dispatch:
    inputs:
      env:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod

      source_path:
        description: "Source file or folder (repo path, e.g. dist/ or backend/app.js)"
        required: true
        type: string

      destination_path:
        description: "Destination path on server (e.g. /var/www/app/)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Detect Environment
        id: envdetect
        run: |
          if [[ "${GITHUB_REF##*/}" == "development" ]]; then
            echo "env=dev" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF##*/}" == "qatest" ]]; then
            echo "env=qa" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF##*/}" == "uat" ]]; then
            echo "env=uat" >> $GITHUB_OUTPUT
          else
            echo "env=${{ github.event.inputs.env }}" >> $GITHUB_OUTPUT
          fi

      - name: Select Server
        id: vars
        run: |
          ENV="${{ steps.envdetect.outputs.env }}"

          if [[ "$ENV" == "dev" ]]; then
            echo "server=${{ secrets.DEV_SERVER }}" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "qa" ]]; then
            echo "server=${{ secrets.QA_SERVER }}" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "uat" ]]; then
            echo "server=${{ secrets.UAT_SERVER }}" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "prod" ]]; then
            echo "server=${{ secrets.PROD_SERVER }}" >> $GITHUB_OUTPUT
          fi
      - name: Install dos2unix
        run: sudo apt-get install -y dos2unix

      - name: Normalize scripts
        run: |
          find . -type f -name "*.sh" -exec dos2unix {} +
          
      - name: Auto version
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d').${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Create Destination Directory
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
          "mkdir -p '${{ github.event.inputs.destination_path }}'"

      - name: Upload File or Folder (Safe)
        run: |
          SOURCE="${{ github.event.inputs.source_path }}"
          DEST="${{ github.event.inputs.destination_path }}"

          if [ -d "$SOURCE" ]; then
            echo "Deploying directory: $SOURCE"
            tar -czf - -C "$SOURCE" . | \
            sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }} \
            "mkdir -p '$DEST' && tar -xzf - -C '$DEST'"
          elif [ -f "$SOURCE" ]; then
            echo "Deploying file: $SOURCE"
            sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
            scp -o StrictHostKeyChecking=no \
            "$SOURCE" \
            ${{ secrets.SERVER_USER }}@${{ steps.vars.outputs.server }}:"$DEST"
          else
            echo "ERROR: Source path not found"
            exit 1
          fi

      - name: Deployment Complete
        run: echo "âœ… Deployment finished successfully"
